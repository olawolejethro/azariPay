name: CI/CD pipeline
on:
  push:
    branches:
      - main
jobs:
  build-test-and-deploy:
    runs-on: ubuntu-latest

    # Add PostgreSQL service for tests
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # Step 1: Check out the repository
      - name: Check out the code
        uses: actions/checkout@v3

      # Step 2: Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 21

      # Step 3: Install dependencies with --legacy-peer-deps
      - name: Install dependencies
        run: npm install --legacy-peer-deps

      # Step 4: Install NestJS CLI
      - name: Install NestJS CLI
        run: npm install -g @nestjs/cli

      # Step 5: Create test environment file
      - name: Create test environment file
        run: |
          cat > .env.test << EOL
          DB_HOST=localhost
          DB_PORT=5432
          DB_USERNAME=postgres
          DB_PASSWORD=postgres
          DB_NAME=test_db
          JWT_SECRET=test-jwt-secret
          JWT_EXPIRATION=1h
          REDIS_HOST=localhost
          REDIS_PORT=6379
          EOL

      # Step 7: Run unit tests
      - name: Run unit tests
        run: npm run test

      # Step 8: Run integration tests
      - name: Run integration tests
        run: npm run test:integration

      # Step 9: Run E2E tests
      - name: Run E2E tests
        run: npm run test:e2e

      # Step 10: Build the project
      - name: Build the project
        run: npm run build

      # Step 11: Deploy to the server
      - name: Deploy to DigitalOcean
        env:
          HOST: ${{ secrets.DEPLOY_HOST }}
          USER: ${{ secrets.DEPLOY_USER }}
          PRIVATE_KEY: ${{ secrets.DEPLOY_KEY }}
          PROJECT_PATH: ${{ secrets.DEPLOY_PROJECT_PATH }}
        run: |
          echo "${PRIVATE_KEY}" > private_key.pem
          chmod 600 private_key.pem
          ssh -i private_key.pem -o StrictHostKeyChecking=no ${USER}@${HOST} << EOF
            cd ${PROJECT_PATH}
            echo "Before reset"
            git rev-parse HEAD
            git fetch origin main
            git reset --hard origin/main
            echo "After reset"
            git rev-parse HEAD
            npm install --legacy-peer-deps
            npm run build
            pm2 restart bongopay
            pm2 save
          EOF
